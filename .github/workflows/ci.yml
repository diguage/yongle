name: Build and Deploy
on:
  push:
    branches:
      - master
jobs:
  build-and-deploy:
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/setup-node
      - name: Setup Node.js ğŸ•¸
        uses: actions/setup-node@v4
        with:
          # https://github.com/nvm-sh/nvm#long-term-support
          node-version: 'lts/*'

      # https://github.com/actions/checkout
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # https://github.com/actions/setup-java
      - name: Set up JDK 21 â˜•ï¸
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: 'maven'

      # https://github.com/marketplace/actions/docker-setup-docker
      - name: Setup Docker ğŸ³
        uses: docker/setup-docker-action@v4

      - name: Add Watermark to Images ğŸ–
        run: |
          docker pull dpokidov/imagemagick
          
          cd docs/assets
          wget https://github.com/diguage/open-fonts/releases/download/latest/SourceCodePro-Semibold.otf
          BASEDIR=$( pwd )/
          
          # å¼‚æ­¥åŠ æ°´å°
          # JPG
          echo " "
          echo -e "\n\n$(date +%T) start to add watermark to JPG"
          find . -type f -name "*.jpg" | grep -v "wx-jikerizhi-qrcode.jpg\|wx-jikerizhi.jpg\|wxpay.jpg" | sed "s/.jpg$//g" | xargs -I {} docker run -v ${BASEDIR}:/imgs dpokidov/imagemagick -compress JPEG2000 -strip -thumbnail "1200x>" -quality 75 -font /imgs/SourceCodePro-Semibold.otf -pointsize 30 -gravity southeast -fill "#DE282A" -draw 'text 15,18 "https://www.diguage.com"' /imgs/{}.jpg /imgs/{}-mark.jpg 1>/dev/null 2>&1 &
          
          wait
          echo -e "$(date +%T) finish adding watermark to JPG...\n\n"
          echo " "
          find . -type f -name "*.jpg" | xargs ls -l -h
          echo " "
          echo -e "\n\n$(date +%T) --start to replace JPG----------------------"
          for f in `find . -type f -name "*-mark.jpg"`;
          do
            name=`echo $f | sed "s/-mark.jpg//g"`
            echo "replace ${f} to ${name}.jpeg"
            rm -rf "${name}.jpg"
            mv "${f}" "${name}.jpg"
          done
          echo -e "$(date +%T) --finish replacing JPG----------------------\n\n"
          echo " "
          find . -type f -name "*.jpg" | xargs ls -l -h
          
          # JPEG
          echo " "
          echo -e "\n\n$(date +%T) start to add watermark to JPEG"
          find . -type f -name "*.jpeg" | sed "s/.jpeg$//g" | xargs -I {} docker run -v ${BASEDIR}:/imgs dpokidov/imagemagick -compress JPEG2000 -strip -thumbnail "1200x>" -quality 75 -font /imgs/SourceCodePro-Semibold.otf -pointsize 30 -gravity southeast -fill "#DE282A" -draw 'text 15,18 "https://www.diguage.com"' /imgs/{}.jpeg /imgs/{}-mark.jpeg 1>/dev/null 2>&1 &
          
          wait
          echo -e "$(date +%T) finish adding watermark to JPEG...\n\n"
          echo " "
          find . -type f -name "*.jpeg" | xargs ls -l -h
          echo " "
          echo -e "\n\n$(date +%T) --start to replace JPEG----------------------"
          for f in `find . -type f -name "*-mark.jpeg"`;
          do
            name=`echo $f | sed "s/-mark.jpeg//g"`
            echo "replace ${f} to ${name}.jpeg"
            rm -rf "${name}.jpeg"
            mv "${f}" "${name}.jpeg"
          done
          echo -e "$(date +%T) --finish replacing JPEG----------------------\n\n"
          echo " "
          find . -type f -name "*.jpeg" | xargs ls -l -h

      #          # PNG
      #          echo " "
      #          echo -e "\n\n$(date +%T) start to add watermark to PNG"
      #          find . -type f -name "*.png" | grep -v "alipay.png\|wxpay.png" | sed "s/.png$//g" | xargs -I {} docker run -v ${BASEDIR}:/imgs dpokidov/imagemagick -strip -resize 1200x -define png:compression-level=9 -define png:exclude-chunk=all -define png:filter-type=1 -font /imgs/SourceCodePro-Semibold.otf -pointsize 30 -gravity southeast -fill "#DE282A" -draw 'text 15,18 "https://www.diguage.com"' /imgs/{}.png /imgs/{}-mark.png 1>/dev/null 2>&1 &
      #
      #          wait
      #          echo -e "$(date +%T) finish adding watermark to PNG...\n\n"
      #          echo " "
      #          find . -type f -name "*.png" | xargs ls -l -h
      #          echo " "
      #          echo -e "\n\n$(date +%T) --start to replace PNG----------------------"
      #          for f in `find . -type f -name "*-mark.png"`;
      #          do
      #            name=`echo $f | sed "s/-mark.png//g"`
      #            echo "replace ${f} to ${name}.png"
      #            rm -rf "${name}.png"
      #            mv "${f}" "${name}.png"
      #          done
      #          echo -e "$(date +%T) --finish replacing PNG----------------------\n\n"
      #          echo " "
      #          find . -type f -name "*.png" | xargs ls -l -h

      - name: Install Graphviz ğŸ°
        run: |
          sudo apt update -y -m
          sudo apt install -y python3-pip
          # https://graphviz.org/
          sudo apt install -y graphviz
          # http://blockdiag.com/en/seqdiag/index.html
          pip3 install seqdiag
          # http://blockdiag.com/en/blockdiag/index.html
          pip3 install blockdiag
          # http://blockdiag.com/en/actdiag/index.html
          pip3 install actdiag
          # http://blockdiag.com/en/nwdiag/index.html
          pip3 install nwdiag
          # https://github.com/Deep-Symmetry/bytefield-svg
          npm install -g bytefield-svg
          # https://github.com/gtudan/bpmn-js-cmd
          npm install -g bpmn-js-cmd
          # https://plantuml.com/zh/
          sudo apt -y install plantuml

      - name: Install font ğŸƒ
        run: |
          mkdir $HOME/.fonts
          cd $HOME/.fonts
          declare -a fonts=('https://github.com/diguage/open-fonts/releases/download/latest/NotoEmoji-Regular.ttf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceCodePro-Regular.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceCodePro-Semibold.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceCodePro-It.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceCodePro-Bold.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceCodePro-BoldIt.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/JetBrainsMono-Regular.ttf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/JetBrainsMono-SemiBold.ttf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/JetBrainsMono-Bold.ttf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSerifSC-Regular.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSerifSC-Bold.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSerifSC-Medium.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSerifSC-SemiBold.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSansSC-Regular.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSansSC-Bold.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSansSC-Medium.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/SourceHanSansSC-Heavy.otf' \
                  'https://github.com/diguage/open-fonts/releases/download/latest/Symbola.ttf')
          for font in "${fonts[@]}"
          do
            name=`echo $font | awk -F'/' '{print $NF}'`
            if [ -f "$name" ]; then
              echo "$name exists."
            else
            until wget $font
            do
              echo "Try to download $name again..."
            done
            fi
          done

      - name: Check font ğŸ”
        run: |
          echo -e "[seqdiag]\nfontpath = $HOME/.fonts/SourceHanSerifSC-Regular.otf" > $HOME/.blockdiagrc
          echo -e "\n[blockdiag]\nfontpath = $HOME/.fonts/SourceHanSerifSC-Regular.otf" >> $HOME/.blockdiagrc
          echo -e "\n[actdiag]\nfontpath = $HOME/.fonts/SourceHanSerifSC-Regular.otf" >> $HOME/.blockdiagrc
          echo -e "\n[nwdiag]\nfontpath = $HOME/.fonts/SourceHanSerifSC-Regular.otf" >> $HOME/.blockdiagrc
          ls -lh $HOME/.fonts 
          fc-list
          cat $HOME/.blockdiagrc

      - name: Build ğŸ—
        run: mvn clean package

      - name: Add Reward Qrcode ğŸ’°
        run: |
          cd target/docs/multipage/
          find . -name "*.html" | grep -v "preface.html" | xargs -I {} sed -i 's@\(<div id="content">\)@\1<div class="sect2"><h3 id="_å‹æƒ…æ”¯æŒ">å‹æƒ…æ”¯æŒ</h3><div class="paragraph"><p>å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªç¬”è®°å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œçœ‹åœ¨Dç“œå“¥ç è¿™ä¹ˆå¤šå­—çš„è¾›è‹¦ä¸Šï¼Œè¯·å‹æƒ…æ”¯æŒä¸€ä¸‹ï¼ŒDç“œå“¥æ„Ÿæ¿€ä¸å°½ï¼ŒğŸ˜œ</p></div><table class="tableblock frame-none grid-all stretch"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><tbody><tr><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./assets/images/alipay.png" alt="æ”¯ä»˜å®" width="85%" title="æ”¯ä»˜å®"></span></p></td><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./assets/images/wxpay.jpg" alt="å¾®ä¿¡" width="85%" title="å¾®ä¿¡"></span></p></td></tr></tbody></table><div class="paragraph"><p>æœ‰äº›æ‰“èµçš„æœ‹å‹å¸Œæœ›å¯ä»¥åŠ ä¸ªå¥½å‹ï¼Œæ¬¢è¿å…³æ³¨D ç“œå“¥çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡å…¬ä¼—å·çš„å›å¤ç›´æ¥ç»™æˆ‘å‘ä¿¡æ¯ã€‚</p></div><div class="paragraph"><p><span class="image"><img src="./assets/images/wx-jikerizhi.png" alt="wx jikerizhi" width="98%"></span></p></div><div class="admonitionblock tip"><table><tbody><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content"><strong>å…¬ä¼—å·çš„å¾®ä¿¡å·æ˜¯: <code>jikerizhi</code></strong>ã€‚<em>å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œæœ‰æ—¶å›¾ç‰‡åŠ è½½ä¸å‡ºæ¥ã€‚ å¦‚æœå›¾ç‰‡åŠ è½½ä¸å‡ºæ¥å¯ä»¥ç›´æ¥é€šè¿‡æœç´¢å¾®ä¿¡å·æ¥æŸ¥æ‰¾æˆ‘çš„å…¬ä¼—å·ã€‚</em></td></tr></tbody></table></div></div>@' {}

      - name: Add Tab Resource ğŸŒ—
        run: |
          cp -R docs/assets target/docs/multipage/
          cp -R docs/assets target/docs/html/
          cd target/docs/
          find . -name "*.html" | xargs -I {} sed -i 's@src="asciidoctor-tabs.js"@src="assets/scripts/asciidoctor-tabs.js"@g' {}

      - name: Add Scroll TOC JS ğŸŒ
        run: |
          mkdir -p target/docs/multipage/assets/scripts/
          touch target/docs/multipage/assets/scripts/scroll-toc.js
          cat > target/docs/multipage/assets/scripts/scroll-toc.js <<- EOF
            document.querySelector('#toc li a span.toc-current')
              .scrollIntoView({ behavior: "smooth", block: "center", inline: "nearest" });
          EOF
          cd target/docs/multipage/
          sed -i 's@</body>@<script src="assets/scripts/scroll-toc.js"></script></body>@g' *.html
          sed -i 's@\(.toc-current{\)@\1color:#d14;font-size:130%;@g' *.html

      - name: Rename Title ğŸ¤¡
        run: |
          cd target/docs/multipage/
          for file in ./*.html;
          do
            # https://ioflood.com/blog/bash-not-equal/
            if [ "${file}" != "./index.html" ]; then
              subtitle=$(grep '<h2.*></a>' $file | awk -F'>' '{print $4}' | awk -F'<' '{print $1}')
              echo "$file -- $subtitle"
              if [ "${subtitle}" != "" ]; then
                # å°†å˜é‡ä¸­çš„ & æ›¿æ¢ä¸º \&
                escaped_title=$(sed 's/&/\\&/g' <<< "${subtitle}") 
                sed -i "s@</h1>@: ${escaped_title}</h1>@g" $file
                sed -i "s@</title>@: ${escaped_title}</title>@g" $file
              fi
            fi
          done

      # https://goalsmashers.github.io/css-minification-benchmark/
      - name: Compress CSS ğŸ­
        run: |
          # https://github.com/parcel-bundler/lightningcss
          npm install -g cssnano-cli
          # Multiple HTML page
          cd target/docs/
          for f in `find . -name "*.css"`;
          do
            if [[ $f == *asciidoctor.css ]]; then
              echo -e '\na{text-decoration:none;}p>code,strong>code{color: #d14 !important;background-color: #f5f5f5 !important;border: 1px solid #e1e1e8;}' >> $f
            fi
            fn="${f%.*}.min.css";
            echo  "compress $f"
            cssnano $f $fn;
            rm -rf $f;
            mv $fn $f
          done

      # https://github.com/privatenumber/minification-benchmarks
      - name: Compress JS ğŸ¢
        run: |
          # https://github.com/mishoo/UglifyJS
          npm install uglify-js -g
          # Multiple HTML page
          cd target/docs/
          for f in `find . -name "*.js"`;
          do
            fn="${f%.*}.min.css";
            echo  "compress $f"
            uglifyjs $f --compress --rename -o $fn
            rm -rf $f;
            mv $fn $f
          done

#      # https://github.com/Burnett01/rsync-deployments
#      # CfgOptions https://github.com/diguage/yongle/settings/secrets/actions
#      - name: Rsync Deploy ğŸ¹
#        uses: burnett01/rsync-deployments@5.2
#        with:
#          switches: -avzr --delete
#          path: target/docs/multipage/
#          remote_path: ${{ secrets.DEPLOY_PATH }}
#          remote_host: ${{ secrets.DEPLOY_HOST }}
#          remote_port: ${{ secrets.DEPLOY_PORT }}
#          remote_user: ${{ secrets.DEPLOY_USER }}
#          remote_key: ${{ secrets.DEPLOY_KEY }}

#      # https://github.com/appleboy/ssh-action
#      - name: Change Files Mod ğŸ”
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ secrets.DEPLOY_HOST }}
#          port: ${{ secrets.DEPLOY_PORT }}
#          username: ${{ secrets.DEPLOY_USER }}
#          key: ${{ secrets.DEPLOY_KEY }}
#          script: |
#            cd ${{ secrets.DEPLOY_PATH }}
#            sudo chmod -R 777 *

      - name: Generate index.html ğŸ 
        run: echo '<ul><li><a href="./html/index.html" class="href">HTML</a></li><li><a href="./multipage/index.html" class="href">Multipage</a></li><li><a href="./pdf/index.pdf" class="href">PDF</a></li><li><a href="./epub/index.epub" class="href">ePub</a></li></ul>' > target/docs/index.html

      # https://github.com/JamesIves/github-pages-deploy-action
      - name: Deploy ğŸš€
        continue-on-error: true
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: target/docs # The folder the action should deploy.
          single-commit: true
